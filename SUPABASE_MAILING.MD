# Documentation Sch√©ma Mailing - 000-CADO

## Vue d'Ensemble

Le sch√©ma `mailing` constitue le **syst√®me de communication et d√©livrabilit√© emails** de 000-CADO avec **5 tables** orchestrant la gestion des domaines, validation des emails, et filtrage intelligent des contacts. Il assure la d√©livrabilit√© optimale des communications automatis√©es et la conformit√© avec les standards email.

### Statistiques G√©n√©rales

- **5 tables** sp√©cialis√©es gestion emails
- **5 colonnes JSONB** pour structures flexibles
- **2 colonnes UUID** pour identifiants distribu√©s
- **10 timestamps** pour audit temporel complet
- **Aucune relation** externe (sch√©ma autonome)
- **1 fonction trigger** pour audit automatique
- **Propri√©taire** : postgres (sch√©ma m√©tier custom)

## Architecture du Syst√®me Mailing

### üéØ **Workflow de D√©livrabilit√© et Communication**

```
Domaines r√©f√©rents ‚Üí domain_references (r√©putation + validation)
        ‚Üì
Patterns emails ‚Üí email_patterns (validation + normalisation)
        ‚Üì
Mod√®les filtrage ‚Üí filter_models (r√®gles + scoring)
        ‚Üì
Contacts qualifi√©s ‚Üí filtered_contacts (contacts valid√©s)
        ‚Üì
Gestion doublons ‚Üí domain_references_duplicate (backup + nettoyage)
```

## Tables par Domaine Fonctionnel

### üè¢ **1. Gestion des Domaines et R√©putation** (2 tables)

#### **Table `domain_references` - Base de Donn√©es des Domaines**

**C≈ìur du syst√®me de d√©livrabilit√©** avec gestion intelligente des domaines :

```sql
-- Identification domaine
id INTEGER PRIMARY KEY,
domain TEXT NOT NULL UNIQUE,           -- Domaine principal (ex: 'company.com')
company TEXT NOT NULL,                 -- Nom de l'entreprise associ√©e

-- Intelligence artificielle
modele TEXT,                           -- Mod√®le de classification du domaine
guessed_company_variants JSONB,        -- Variantes intelligentes du nom d'entreprise

-- Audit temporel
created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
```

**Fonctionnalit√©s r√©v√©l√©es** :

- **D√©duplication intelligente** : Contrainte unique sur domaine
- **Classification automatique** : Mod√®les de reconnaissance d'entreprises
- **Variants IA** : D√©tection automatique des variantes de noms d'entreprise
- **Gestion r√©putation** : Suivi historique des domaines exp√©diteurs

#### **Structure JSONB `guessed_company_variants`**

```json
{
  "primary_name": "Acme Corporation",
  "variants": ["Acme Corp", "Acme Inc", "ACME", "Acme Company"],
  "confidence_scores": {
    "Acme Corp": 0.95,
    "Acme Inc": 0.87,
    "ACME": 0.92
  },
  "source": "ml_model_v2.1",
  "last_updated": "2025-06-13T10:30:00Z"
}
```

#### **Table `domain_references_duplicate` - Gestion des Doublons**

**Structure identique** √† `domain_references` mais pour :

- **Backup avant nettoyage** : Sauvegarde des doublons avant suppression
- **Analyse qualit√©** : Comparaison et am√©lioration des donn√©es
- **Tra√ßabilit√©** : Historique des op√©rations de d√©duplication

### üìß **2. Validation et Patterns d'Emails** (1 table)

#### **Table `email_patterns` - Moteur de Validation**

**Syst√®me de validation avanc√©** avec patterns configurables :

```sql
-- Identification pattern
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
name VARCHAR(100) NOT NULL UNIQUE,         -- Nom du pattern (ex: 'corporate_email')
description TEXT NOT NULL,                 -- Description du pattern

-- Configuration validation
pattern VARCHAR(255),                      -- Expression r√©guli√®re ou pattern
pattern_function TEXT NOT NULL,            -- Fonction de validation personnalis√©e
is_default BOOLEAN NOT NULL DEFAULT false, -- Pattern par d√©faut

-- Audit
created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
```

**Patterns r√©v√©l√©s par les donn√©es** (16 patterns configur√©s) :

- **Validation corporate** : Patterns pour emails professionnels
- **D√©tection domaines** : Reconnaissance automatique des domaines valides
- **Normalisation** : Standardisation des formats d'emails
- **Scoring qualit√©** : √âvaluation de la validit√© des emails

#### **Exemples de Patterns Configur√©s**

```sql
-- Pattern email professionnel
name: 'corporate_email'
pattern: '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
pattern_function: 'validate_corporate_domain'

-- Pattern d√©tection g√©n√©rique
name: 'generic_email_filter'
pattern_function: 'filter_generic_addresses'
is_default: true
```

### üîç **3. Syst√®me de Filtrage Intelligent** (2 tables)

#### **Table `filter_models` - Mod√®les de Filtrage**

**IA de qualification des contacts** avec r√®gles complexes :

```sql
-- Identification mod√®le
id VARCHAR(255) PRIMARY KEY,              -- ID mod√®le (ex: 'enterprise_filter_v2')
name VARCHAR(255) NOT NULL,               -- Nom descriptif du mod√®le
description TEXT,                         -- Description d√©taill√©e

-- R√®gles de filtrage intelligentes
include_rules JSONB,                      -- R√®gles d'inclusion
exclude_rules JSONB,                      -- R√®gles d'exclusion
features JSONB,                           -- Caract√©ristiques du mod√®le
threshold NUMERIC,                        -- Seuil de confiance

-- Audit
created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
```

#### **Structure JSONB des R√®gles de Filtrage**

**`include_rules` - Crit√®res d'Inclusion**

```json
{
  "domain_rules": {
    "allowed_domains": ["*.com", "*.org", "*.edu"],
    "required_mx_record": true,
    "min_domain_age_days": 30
  },
  "contact_rules": {
    "required_fields": ["first_name", "last_name", "company"],
    "title_keywords": ["CEO", "CTO", "Manager", "Director"],
    "company_size_min": 10
  },
  "behavioral_rules": {
    "email_engagement_score": 0.7,
    "recent_activity_days": 90
  }
}
```

**`exclude_rules` - Crit√®res d'Exclusion**

```json
{
  "spam_indicators": {
    "generic_domains": ["gmail.com", "yahoo.com", "hotmail.com"],
    "suspicious_patterns": ["test", "demo", "temp", "fake"],
    "blacklisted_domains": ["spam-domain.com"]
  },
  "quality_filters": {
    "min_email_length": 5,
    "max_email_length": 100,
    "invalid_characters": ["<", ">", "&"]
  }
}
```

**`features` - Caract√©ristiques du Mod√®le**

```json
{
  "model_version": "2.1",
  "training_data_size": 50000,
  "accuracy_metrics": {
    "precision": 0.94,
    "recall": 0.87,
    "f1_score": 0.9
  },
  "feature_weights": {
    "domain_reputation": 0.3,
    "email_format": 0.2,
    "contact_completeness": 0.5
  }
}
```

#### **Table `filtered_contacts` - Contacts Qualifi√©s**

**R√©sultats du filtrage intelligent** avec scoring d√©taill√© :

```sql
-- Identification contact
id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
contact_id VARCHAR(255) NOT NULL,         -- ID externe du contact

-- Donn√©es contact
first_name VARCHAR(255), last_name VARCHAR(255),
title VARCHAR(500), company VARCHAR(255),
email VARCHAR(255), phone VARCHAR(100),

-- R√©sultats filtrage
filter_status USER-DEFINED NOT NULL DEFAULT 'uncertain',  -- Statut qualification
filter_method USER-DEFINED,                               -- M√©thode utilis√©e
filter_confidence NUMERIC,                                -- Score de confiance

-- Tra√ßabilit√© batch
batch_id VARCHAR(255) NOT NULL,                          -- ID du lot de traitement
batch_name VARCHAR(255),                                 -- Nom du lot
model_id VARCHAR(255),                                   -- Mod√®le utilis√©
model_name VARCHAR(255),                                 -- Nom du mod√®le
source_id VARCHAR(255),                                  -- Source des donn√©es

-- Audit
created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now(),
updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT now()
```

#### **√ânum√©rations Personnalis√©es**

**`filter_status` - Statuts de Qualification**

- `'uncertain'` (d√©faut) : Statut ind√©termin√©, n√©cessite validation
- `'qualified'` : Contact qualifi√©, pr√™t pour mailing
- `'disqualified'` : Contact rejet√© par les filtres
- `'pending'` : En cours de qualification
- `'validated'` : Valid√© manuellement

**`filter_method` - M√©thodes de Filtrage**

- `'ml_model'` : Filtrage par mod√®le machine learning
- `'rule_based'` : Filtrage par r√®gles m√©tier
- `'manual'` : Validation manuelle
- `'hybrid'` : Combinaison de m√©thodes

## Contraintes et Optimisations

### üîí **Contraintes M√©tier Strictes**

#### **Unicit√© et Int√©grit√©**

```sql
-- Unicit√© des domaines (d√©duplication)
domain_references_domain_key: UNIQUE (domain)
domain_references_duplicate_domain_key: UNIQUE (domain)

-- Unicit√© des patterns email
email_patterns_name_unique: UNIQUE (name)

-- Champs obligatoires pour qualit√©
domain IS NOT NULL, company IS NOT NULL (domain_references)
contact_id IS NOT NULL, batch_id IS NOT NULL (filtered_contacts)
```

### ‚ö° **Optimisations Performance Massives**

#### **Index Sp√©cialis√©s D√©livrabilit√©** (20 index optimis√©s)

**Domaine Management** (11 index)

```sql
-- Recherche par domaine (performance critique)
CREATE INDEX idx_domain_references_domain ON domain_references (domain);
CREATE INDEX idx_domain_references_company ON domain_references (company);

-- Recherche par mod√®le (classification)
CREATE INDEX domain_references_modele_idx ON domain_references (modele);

-- Doublons avec index identiques pour performance
CREATE INDEX domain_references_duplicate_domain_idx ON domain_references_duplicate (domain);
```

**Email Validation** (4 index)

```sql
-- Patterns par nom et d√©faut
CREATE INDEX email_patterns_name_idx ON email_patterns (name);
CREATE INDEX email_patterns_is_default_idx ON email_patterns (is_default);
```

**Filtrage System** (5 index)

```sql
-- Performance filtrage batch
CREATE INDEX idx_filtered_contacts_batch_id ON filtered_contacts (batch_id);
CREATE INDEX idx_filtered_contacts_status ON filtered_contacts (filter_status);
CREATE INDEX idx_filtered_contacts_method ON filtered_contacts (filter_method);
```

### üîÑ **Automatisations et Triggers**

#### **Trigger de Mise √† Jour Automatique**

```sql
-- Fonction trigger pour audit timestamps
CREATE FUNCTION mailing.update_modified_column() RETURNS TRIGGER;

-- Triggers automatiques
CREATE TRIGGER update_filter_models_timestamp
BEFORE UPDATE ON filter_models
FOR EACH ROW EXECUTE FUNCTION update_modified_column();

CREATE TRIGGER update_filtered_contacts_timestamp
BEFORE UPDATE ON filtered_contacts
FOR EACH ROW EXECUTE FUNCTION update_modified_column();
```

## Volum√©trie et Patterns d'Usage

### üìä **Donn√©es Op√©rationnelles R√©v√©latrices**

| Table                           | Lignes  | Insertions | Mises √† jour | Suppressions | Pattern          | Insight                          |
| ------------------------------- | ------- | ---------- | ------------ | ------------ | ---------------- | -------------------------------- |
| **domain_references**           | **803** | **1,971**  | **3,325**    | **1,168**    | **UPDATE_HEAVY** | **Base active avec maintenance** |
| **email_patterns**              | **16**  | **16**     | **0**        | **0**        | **INSERT_HEAVY** | **Configuration stable**         |
| **filtered_contacts**           | **0**   | **0**      | **0**        | **0**        | **STATIC**       | **Fonctionnalit√© pr√™te**         |
| **filter_models**               | **0**   | **0**      | **0**        | **0**        | **STATIC**       | **Mod√®les en pr√©paration**       |
| **domain_references_duplicate** | **0**   | **0**      | **0**        | **0**        | **STATIC**       | **Syst√®me de backup**            |

#### **Insights Op√©rationnels Critiques**

**Syst√®me de Domaines Hautement Actif**

- **803 domaines** r√©f√©renc√©s avec **3,325 mises √† jour** ‚Üí Maintenance active de la r√©putation
- **1,168 suppressions** ‚Üí Nettoyage qualit√© r√©gulier
- **Autovacuum** : 6 mai 2025 ‚Üí Maintenance base optimis√©e

**Configuration Email Stable**

- **16 patterns** configur√©s sans modifications ‚Üí Syst√®me de validation mature
- **Patterns fig√©s** ‚Üí R√®gles de validation √©prouv√©es

**Potentiel de Filtrage Inexploit√©**

- **Tables vides** : `filtered_contacts` et `filter_models` ‚Üí Fonctionnalit√©s avanc√©es pr√™tes
- **Infrastructure pr√©par√©e** ‚Üí Syst√®me de qualification IA pr√™t √† l'emploi

## S√©curit√© et Gouvernance

### üîê **Row Level Security (RLS) Sophistiqu√©e**

**Politiques de s√©curit√© granulaires** (5 politiques sur `domain_references`) :

```sql
-- Acc√®s utilisateurs authentifi√©s
'allow_select_for_authenticated_users' WHERE auth.role() = 'authenticated'
'allow_insert_for_authenticated_users' WHERE auth.role() = 'authenticated'
'allow_update_for_authenticated_users' WHERE auth.role() = 'authenticated'

-- Acc√®s service complet
'domain_references_all_policy' FOR service_role WHERE true

-- Acc√®s lecture authentifi√©
'domain_references_select_policy' FOR authenticated WHERE true
```

**Strat√©gie de s√©curit√©** :

- **Utilisateurs authentifi√©s** : CRUD complet sur domaines
- **Service role** : Acc√®s administratif total
- **Anonymes** : Aucun acc√®s (s√©curit√© par d√©faut)

### üèõÔ∏è **Gouvernance des Donn√©es**

#### **Sch√©ma Autonome**

- **Aucune relation externe** : Ind√©pendance totale des autres sch√©mas
- **Responsabilit√© isol√©e** : Gestion exclusive des donn√©es mailing
- **√âvolution ind√©pendante** : Modifications sans impact sur autres modules

#### **Qualit√© et Conformit√©**

- **Contraintes strictes** : Domaines et contacts uniques
- **Audit complet** : Timestamps sur toutes les tables
- **Tra√ßabilit√© batch** : Suivi des op√©rations de masse
- **RGPD ready** : S√©paration des donn√©es personnelles

## Int√©gration avec l'√âcosyst√®me 000-CADO

### üîÑ **Flux de Donn√©es Mailing**

```
Marketing Automation (schema marketing)
    ‚Üì (extraction contacts)
Domain Validation (domain_references)
    ‚Üì (v√©rification r√©putation)
Email Pattern Validation (email_patterns)
    ‚Üì (normalisation format)
Intelligent Filtering (filter_models)
    ‚Üì (qualification IA)
Qualified Contacts (filtered_contacts)
    ‚Üì (contacts valid√©s)
Email Delivery System (externe)
```

### ü§ñ **Intelligence Artificielle Int√©gr√©e**

#### **Classification Automatique des Domaines**

- **Mod√®les ML** : Reconnaissance automatique des entreprises
- **Variants intelligents** : D√©tection des noms d'entreprise similaires
- **Scoring r√©putation** : √âvaluation de la qualit√© des domaines

#### **Filtrage Intelligent des Contacts**

- **R√®gles complexes** : Include/exclude rules avec JSONB flexible
- **Scoring confiance** : √âvaluation probabiliste de la qualit√©
- **Traitement batch** : Qualification massive de contacts

#### **Validation Avanc√©e**

- **Patterns configurables** : Validation adapt√©e par contexte
- **Fonctions personnalis√©es** : Logique m√©tier sp√©cialis√©e
- **D√©duplication intelligente** : Gestion automatique des doublons

## Workflows de Communication

### üì¨ **Sc√©nario Type : Campagne Email Qualifi√©e**

#### **1. Pr√©paration des Domaines**

```sql
-- Validation et mise √† jour des domaines
UPDATE domain_references
SET modele = 'enterprise_v2',
    guessed_company_variants = '{"variants": ["Acme Corp", "Acme Inc"]}'
WHERE domain = 'acme.com';
```

#### **2. Configuration des Patterns**

```sql
-- Pattern pour emails professionnels
INSERT INTO email_patterns (name, description, pattern_function, is_default)
VALUES ('corporate_filter', 'Filtre emails professionnels', 'validate_corporate', true);
```

#### **3. Filtrage Intelligent des Contacts**

```sql
-- Configuration mod√®le de filtrage
INSERT INTO filter_models (id, name, include_rules, threshold)
VALUES ('enterprise_2025', 'Mod√®le Enterprise Q2 2025',
        '{"domain_rules": {"min_domain_age": 30}}', 0.85);

-- Qualification des contacts
INSERT INTO filtered_contacts (contact_id, email, company, filter_status, batch_id)
SELECT contact_id, email, company, 'qualified', 'batch_2025_06'
FROM marketing.contacts
WHERE email_quality_score > 0.8;
```

#### **4. D√©livrabilit√© Optimis√©e**

```sql
-- S√©lection des contacts qualifi√©s pour envoi
SELECT fc.email, fc.company, dr.domain, dr.modele
FROM filtered_contacts fc
JOIN domain_references dr ON SPLIT_PART(fc.email, '@', 2) = dr.domain
WHERE fc.filter_status = 'qualified'
  AND fc.filter_confidence > 0.9
  AND dr.modele IS NOT NULL;
```

## Fonctions M√©tier Int√©gr√©es

### üîß **Utilitaires de Gestion des Domaines**

**Fonctions bulk r√©v√©l√©es** (r√©f√©renc√©es dans le sch√©ma `public`) :

- `bulk_import_domain_references()` : Import en masse de domaines
- `bulk_replace_domain_references()` : Remplacement complet de r√©f√©rences
- `bulk_upsert_domain_references()` : Mise √† jour intelligente avec gestion conflits
- `update_domain_reference()` : Mise √† jour unitaire avec validation

**Usage probable** :

```sql
-- Import massif depuis source externe
SELECT public.bulk_import_domain_references('fichier_domaines_2025.csv');

-- Mise √† jour intelligente avec d√©duplication
SELECT public.bulk_upsert_domain_references('nouveaux_domaines.json');
```

---

## Conclusion

Le sch√©ma `mailing` r√©v√®le un **syst√®me de communication enterprise sophistiqu√©** qui va bien au-del√† du simple envoi d'emails. Avec son **intelligence artificielle int√©gr√©e** , sa **gestion de r√©putation des domaines** , et son **syst√®me de qualification avanc√©** , il constitue une infrastructure de d√©livrabilit√© de niveau professionnel.

L'architecture **autonome** (aucune relation externe), les **optimisations performance** (20 index sp√©cialis√©s), et la **volum√©trie op√©rationnelle** (803 domaines actifs) d√©montrent une maturit√© technique qui positionne 000-CADO comme une solution compl√®te int√©grant communication, qualification IA, et conformit√© r√©glementaire.

Cette sophistication technique, combin√©e √† l'**intelligence artificielle** pour la qualification des contacts et la **gestion proactive de la r√©putation** , constitue un **avantage concurrentiel majeur** dans un environnement o√π la d√©livrabilit√© email devient de plus en plus critique pour le succ√®s des communications business.
