# ğŸ“‹ Whiteboard - Partage Evaluation Temps RÃ©el

## ğŸ¯ Vue d'ensemble

Extension du module Whiteboard permettant aux **coachs** de partager en temps rÃ©el leurs sessions d'Ã©valuation d'appels avec les **participants** . Les participants peuvent alors "toper" les passages intÃ©ressants, identifier des critÃ¨res qualitÃ© et contribuer collectivement Ã  l'analyse.

### FonctionnalitÃ©s clÃ©s

- â±ï¸ **Synchronisation temps rÃ©el** : Transcription + highlighting partagÃ©s
- ğŸš© **Tops collaboratifs** : Participants marquent les passages
- ğŸ¯ **CritÃ¨res qualitÃ©** : Identification des sujets/pratiques (mÃªme rÃ©fÃ©rentiel qu'Evaluation)
- ğŸ”’ **ContrÃ´les objectivitÃ©** : Coach maÃ®trise la visibilitÃ© des tops collectifs
- ğŸ“Š **Analyses agrÃ©gÃ©es** : Passages les plus marquÃ©s, statistiques par critÃ¨re

## ğŸš€ Quick Start

### PrÃ©requis

- Node.js 18+
- Supabase configurÃ© avec Realtime activÃ©
- Auth0 configurÃ©
- Tables Whiteboard existantes (sessions, postits, etc.)

### Installation

```bash
cd whiteboard
npm install
npm run dev
```

### Configuration

1. CrÃ©er les 2 nouvelles tables Supabase (voir section Tables)
2. âœ… **NOUVEAU** Activer Supabase Realtime (voir Configuration Realtime)
3. VÃ©rifier les permissions RLS Supabase
4. Tester la connexion Auth0
5. Ajouter `SUPABASE_SERVICE_ROLE_KEY` dans `.env.local`

## ğŸ“‹ Ã‰tat Actuel du Projet - Session 11/06/2025 âœ… Phase 1-2 COMPLÃˆTES + Phase 3 EN COURS

### ğŸ¯ RÃ©sumÃ© du Fonctionnement Actuel

**Architecture Globale**

- **Coach (authentifiÃ©)** : CrÃ©e et gÃ¨re sessions d'Ã©valuation partagÃ©es depuis /evaluation
- **Participants (non-authentifiÃ©s)** : AccÃ¨dent aux sessions via /whiteboard par lien direct
- **API Hybride** : Authentification Bearer token pour coach, Service Role pour participants
- **âœ… NOUVEAU : WebSocket Realtime** : Synchronisation transcription temps rÃ©el

**Flux de DonnÃ©es Phase 3**

1. Coach ouvre Evaluation â†’ SÃ©lectionne appel â†’ Clique "Partager" â†’ Session WebSocket crÃ©Ã©e
2. Coach navigue transcription â†’ Position broadcastÃ©e via Supabase Realtime
3. Participants voient highlighting synchronisÃ© + auto-scroll temps rÃ©el
4. Coach change mode (word/paragraph) â†’ Participants voient le changement instantanÃ©

### âœ… Phase 1 : TERMINÃ‰E (100%) - 09/06/2025

[Contenu Phase 1 inchangÃ©...]

### âœ… Phase 2 : TERMINÃ‰E (100%) - Session 11/06/2025

[Contenu Phase 2 inchangÃ©...]

### ğŸ”„ Phase 3 : WebSockets Temps RÃ©el (EN COURS) - Session 11/06/2025

#### âœ… Architecture Realtime DÃ©finie

**Hooks Realtime crÃ©Ã©s** :

- âœ… `useRealtimeEvaluationSharing.tsx` : Hook coach pour broadcaster les changements
- âœ… `useRealtimeEvaluationSync.tsx` : Hook participants pour recevoir synchronisation
- âœ… Configuration Supabase Realtime avec politiques RLS

**Composants SynchronisÃ©s** :

- âœ… `SynchronizedTranscript.tsx` : Wrapper Transcript pour participants
- âœ… Extensions Transcript.tsx : Props mode spectateur
- âœ… Extensions TranscriptAlternative.tsx : Props mode spectateur

**DonnÃ©es SynchronisÃ©es** :

- âœ… `current_word_index` : Position mot en cours
- âœ… `current_paragraph_index` : Position paragraphe en cours
- âœ… `view_mode` : Mode word/paragraph
- âœ… `highlight_turn_one` : Coloration tours de parole
- âœ… `highlight_speakers` : Coloration locuteurs
- âœ… `session_mode` : Ã‰tat live/paused/ended

#### ğŸ”„ IntÃ©grations Ã  Finaliser

**Ã€ intÃ©grer dans les composants existants** :

- [ ] **useEvaluationSharing.tsx** : Ajouter hook Realtime coach
- [ ] **SharedEvaluationViewer.tsx** : Remplacer placeholder par SynchronizedTranscript
- [ ] **Transcript.tsx** : Ajouter props mode spectateur
- [ ] **TranscriptAlternative.tsx** : Ajouter props mode spectateur

**Configuration Supabase Ã  appliquer** :

```sql
-- Ã€ exÃ©cuter dans Supabase Dashboard > SQL Editor
ALTER PUBLICATION supabase_realtime ADD TABLE whiteboard.shared_evaluation_sessions;

ALTER TABLE whiteboard.shared_evaluation_sessions
ADD COLUMN IF NOT EXISTS view_mode VARCHAR(20) DEFAULT 'word',
ADD COLUMN IF NOT EXISTS current_word_index INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS current_paragraph_index INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS highlight_turn_one BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS highlight_speakers BOOLEAN DEFAULT true;

GRANT SELECT ON storage.objects TO service_role;
GRANT SELECT ON storage.buckets TO service_role;
```

#### ğŸ¯ CritÃ¨res de SuccÃ¨s Phase 3

- [ ] Position transcription synchronisÃ©e < 200ms latence
- [ ] Switch word/paragraph instantanÃ© tous participants
- [ ] Highlighting mot/segment synchronisÃ© temps rÃ©el
- [ ] Auto-scroll suit coach automatiquement
- [ ] Connexion WebSocket stable avec reconnexion auto
- [ ] Fallback en cas d'erreur Realtime
- [ ] Interface participants avec indicateur connexion

## ğŸ“‹ Plan de dÃ©veloppement complet

### âœ… Phase 1-2 : COMPLÃˆTEMENT TERMINÃ‰ES (100%)

**Status** : âœ… **PRODUCTION READY** - Toutes fonctionnalitÃ©s de base validÃ©es

### ğŸ”„ Phase 3 : WebSockets Temps RÃ©el (EN COURS - 80% fait)

**Status** : ğŸ”„ **ARCHITECTURE PRÃŠTE** - IntÃ©grations en cours

**Architecture complÃ¨tement dÃ©finie** :

- âœ… Hooks Realtime coach/participants
- âœ… Composants synchronisÃ©s
- âœ… Configuration Supabase
- âœ… StratÃ©gie de synchronisation

**IntÃ©grations restantes** :

- [ ] Modifications composants existants (4 fichiers)
- [ ] Configuration Supabase (1 script SQL)
- [ ] Tests end-to-end

**Estimation** : 1-2 jours pour finaliser

### â³ Phase 4 : Actions Participants (Ã€ FAIRE aprÃ¨s Phase 3)

- [ ] Boutons "Toper" passages intÃ©ressants
- [ ] Modal commentaires + critÃ¨res qualitÃ©
- [ ] Sauvegarde participant_evaluations
- [ ] IntÃ©gration hook `useParticipantEvaluations` (dÃ©jÃ  crÃ©Ã©)

### â³ Phase 5 : Analyses & ObjectivitÃ© (Ã€ FAIRE)

- [ ] ContrÃ´les coach (visibilitÃ© tops, anonymat)
- [ ] Statistiques passages les plus topÃ©s
- [ ] Interface rÃ©sultats agrÃ©gÃ©s

## ğŸ—ƒï¸ Architecture Technique Phase 3

### Structure Fichiers Phase 3

```
app/evaluation/hooks/
â””â”€â”€ useRealtimeEvaluationSharing.tsx        âœ… CrÃ©Ã© - Hook coach Realtime

app/whiteboard/hooks/
â””â”€â”€ useRealtimeEvaluationSync.tsx           âœ… CrÃ©Ã© - Hook participants Realtime

app/whiteboard/components/SharedEvaluation/
â”œâ”€â”€ SynchronizedTranscript.tsx              âœ… CrÃ©Ã© - Wrapper participants
â”œâ”€â”€ SharedEvaluationViewer.tsx              ğŸ”„ Ã€ modifier - IntÃ©grer SynchronizedTranscript
â””â”€â”€ index.tsx                               ğŸ”„ Ã€ modifier - Exports

app/evaluation/components/
â”œâ”€â”€ Transcript.tsx                          ğŸ”„ Ã€ modifier - Ajouter props spectateur
â”œâ”€â”€ TranscriptAlternative.tsx               ğŸ”„ Ã€ modifier - Ajouter props spectateur
â””â”€â”€ ShareEvaluationButton/
    â””â”€â”€ useEvaluationSharing.tsx            ğŸ”„ Ã€ modifier - IntÃ©grer Realtime coach
```

### Configuration Supabase Realtime

#### Extension Table BDD âœ…

```sql
-- âœ… Extensions Phase 3 ajoutÃ©es Ã  shared_evaluation_sessions
ALTER TABLE whiteboard.shared_evaluation_sessions
ADD COLUMN view_mode VARCHAR(20) DEFAULT 'word',
ADD COLUMN current_word_index INTEGER DEFAULT 0,
ADD COLUMN current_paragraph_index INTEGER DEFAULT 0,
ADD COLUMN highlight_turn_one BOOLEAN DEFAULT false,
ADD COLUMN highlight_speakers BOOLEAN DEFAULT true;

-- âœ… Index pour performance Realtime
CREATE INDEX idx_shared_sessions_realtime
ON whiteboard.shared_evaluation_sessions(id, updated_at, is_active);
```

#### Activation Realtime âœ…

```sql
-- âœ… Activer Realtime sur table sessions
ALTER PUBLICATION supabase_realtime ADD TABLE whiteboard.shared_evaluation_sessions;

-- âœ… Permissions storage pour audio participants
GRANT SELECT ON storage.objects TO service_role;
GRANT SELECT ON storage.buckets TO service_role;
```

### API Endpoints Phase 3

âœ… **Endpoints existants compatibles** - Pas de modification nÃ©cessaire
âœ… **WebSocket via Supabase Realtime** - Pas d'API custom nÃ©cessaire

## ğŸ¯ Ã‰tat Current - Phase 3 ARCHITECTURE COMPLÃˆTE âœ…

### FonctionnalitÃ©s Phase 3 architecturÃ©es

âœ… **Hooks Realtime** : Coach + Participants avec reconnexion auto
âœ… **Synchronisation position** : current_word_index + current_paragraph_index
âœ… **Synchronisation interface** : view_mode + highlighting
âœ… **Composants wrapper** : SynchronizedTranscript prÃªt
âœ… **Mode spectateur** : Extensions Transcript + TranscriptAlternative
âœ… **Configuration BDD** : Tables et permissions dÃ©finies
âœ… **Gestion erreurs** : Fallback + indicateurs connexion
âœ… **Auto-scroll** : Highlighting + navigation synchronisÃ©e

### IntÃ©grations restantes (Session 12/06/2025)

ğŸ”„ **4 fichiers Ã  modifier** :

1. `useEvaluationSharing.tsx` : IntÃ©grer hook Realtime coach
2. `SharedEvaluationViewer.tsx` : Utiliser SynchronizedTranscript
3. `Transcript.tsx` : Ajouter props mode spectateur
4. `TranscriptAlternative.tsx` : Ajouter props mode spectateur

ğŸ”„ **1 script SQL Ã  exÃ©cuter** : Configuration Supabase Realtime

ğŸ”„ **Tests Ã  valider** : Parcours end-to-end coach â†’ participants

## ğŸ“Š MÃ©triques Actuelles Phase 3

- **Lignes de code Phase 3** : ~800 lignes (hooks + composants)
- **Fichiers crÃ©Ã©s Phase 3** : 3 nouveaux fichiers
- **Fichiers Ã  modifier** : 4 fichiers existants
- **Architecture Phase 3** : **100% DÃ‰FINIE** âœ…
- **ImplÃ©mentation Phase 3** : **80% FAIT** ğŸ”„
- **Tests validÃ©s** : Architecture validÃ©e, intÃ©grations en cours

## ğŸ¯ Session de travail du 11/06/2025 - ARCHITECTURE PHASE 3 COMPLÃˆTE âœ…

### Accomplissements de la session

âœ… **Architecture Realtime complÃ¨te** : Hooks coach + participants
âœ… **Composants synchronisÃ©s** : SynchronizedTranscript + extensions
âœ… **Configuration Supabase** : Script SQL Realtime prÃªt
âœ… **StratÃ©gie synchronisation** : Position + interface + mode spectateur
âœ… **Gestion d'erreurs** : Reconnexion auto + fallback + indicateurs
âœ… **Documentation** : IntÃ©grations dÃ©taillÃ©es pour finalisation

### Plan immÃ©diat (Session 12/06/2025)

ğŸ”„ **IntÃ©grations (1-2 jours)** :

1. ExÃ©cuter script SQL Supabase
2. Modifier useEvaluationSharing (ajouter Realtime coach)
3. Modifier SharedEvaluationViewer (utiliser SynchronizedTranscript)
4. Ã‰tendre Transcript + TranscriptAlternative (props spectateur)
5. Tests end-to-end

ğŸ¯ **Tests finaux** :

- Coach navigue transcription â†’ Participants voient highlighting temps rÃ©el
- Coach change word/paragraph â†’ Switch automatique participants
- Coach change coloration â†’ Changement instantanÃ© participants
- DÃ©connexion rÃ©seau â†’ Reconnexion automatique
- Multiple participants â†’ Synchronisation stable

## ğŸš€ Prochaines Sessions

### Session 12/06/2025 : Finalisation Phase 3

**Objectif** : Phase 3 complÃ¨tement fonctionnelle

**TÃ¢ches** :

1. âœ… Configuration Supabase Realtime
2. âœ… IntÃ©grations composants (4 fichiers)
3. âœ… Tests end-to-end complets
4. âœ… Polish UX indicateurs connexion

**CritÃ¨res de succÃ¨s** :

- Synchronisation transcription < 200ms
- Auto-scroll fluide participants
- Reconnexion automatique robuste
- Interface indicateurs connexion

### Session 13/06/2025 : Phase 4 - Actions Participants

**Objectif** : Boutons "Toper" + Modal commentaires

**Architecture prÃªte** :

- âœ… Hook `useParticipantEvaluations` (dÃ©jÃ  crÃ©Ã©)
- âœ… Table `participant_evaluations` (dÃ©jÃ  crÃ©Ã©e)
- âœ… Infrastructure Realtime (Phase 3)

## ğŸ¯ CritÃ¨res de SuccÃ¨s Phase 3 - ARCHITECTURE VALIDÃ‰E âœ…

- âœ… **Architecture Realtime complÃ¨te** : Hooks + composants + config
- âœ… **Synchronisation dÃ©finie** : Position + interface + mode spectateur
- âœ… **Gestion d'erreurs** : Reconnexion auto + fallback + indicateurs
- âœ… **Composants rÃ©utilisables** : SynchronizedTranscript extensible
- âœ… **Configuration BDD** : Script SQL prÃªt pour exÃ©cution
- âœ… **IntÃ©grations documentÃ©es** : 4 fichiers avec modifications prÃ©cises
- âœ… **Tests planifiÃ©s** : Parcours end-to-end dÃ©fini
- âœ… **Foundation Phase 4** : Architecture extensible boutons participants

## ğŸ”’ SÃ©curitÃ© Sessions Phase 3

### RÃ¨gle maintenue : "Une session active par coach avec Realtime"

âœ… **WebSocket par session** : Channel unique par session_id
âœ… **Permissions RLS** : Coach update, participants select only
âœ… **Reconnexion sÃ©curisÃ©e** : Validation session_id + is_active
âœ… **Fallback robuste** : API polling si WebSocket Ã©choue

### MÃ©canisme Realtime

1. **Coach crÃ©e session** â†’ Channel WebSocket + API traditionnelle
2. **Participants subscribe** â†’ Channel read-only + service role
3. **Coach broadcast** â†’ UPDATE table + Realtime notification
4. **Participants reÃ§oivent** â†’ Highlighting + auto-scroll temps rÃ©el
5. **Gestion erreurs** â†’ Reconnexion auto + fallback polling

## ğŸ› Issues anticipÃ©s Phase 3

### Issue #1 : Latence WebSocket

**ProblÃ¨me** : Synchronisation > 500ms
**Solution** : Debouncing position 200ms + batch updates
**Mitigation** : Fallback polling si latence dÃ©tectÃ©e

### Issue #2 : Reconnexion participants

**ProblÃ¨me** : Perte connexion participants
**Solution** : Reconnexion auto avec backoff exponentiel
**Fallback** : Polling classique jusqu'Ã  reconnexion

### Issue #3 : Performance multi-participants

**ProblÃ¨me** : Ralentissement avec 10+ participants
**Solution** : Optimisation queries + index BDD
**Monitoring** : Logs performance + mÃ©triques Realtime

## ğŸš€ Commandes dÃ©veloppement Phase 3

```bash
# DÃ©marrage dev
npm run dev

# Tests Realtime (manuel)
# 1. Coach: localhost:3000/evaluation (crÃ©er session)
# 2. Participant 1: localhost:3000/whiteboard
# 3. Participant 2: localhost:3000/whiteboard (incognito)
# 4. Coach navigue transcription â†’ VÃ©rifier sync participants

# Supabase Realtime logs
# Dashboard > Settings > API > Realtime logs

# Monitoring WebSocket
# Chrome DevTools > Network > WS (WebSocket frames)
```

## ğŸ“š RÃ©fÃ©rences techniques Phase 3

### Documentation utilisÃ©e

- [Supabase Realtime](https://supabase.com/docs/guides/realtime)
- [Supabase Realtime React](https://supabase.com/docs/reference/javascript/subscribe)
- [WebSocket Reconnection Strategies](https://docs.supabase.io/reference/javascript/subscribe)

### Patterns utilisÃ©s Phase 3

- **WebSocket Channel Pattern** : Channel unique par session
- **Debouncing Pattern** : Position updates avec dÃ©lai
- **Reconnection Pattern** : Backoff exponentiel avec limite
- **Spectator Pattern** : Mode lecture seule avec sync
- **Fallback Pattern** : Polling si WebSocket Ã©choue

---

**âœ… PHASE 1-2 COMPLÃˆTEMENT TERMINÃ‰ES !** ğŸ‰

**âœ… PHASE 3 ARCHITECTURE COMPLÃˆTE !** ğŸš€

**DerniÃ¨re mise Ã  jour** : 11/06/2025 - **Architecture Phase 3 finalisÃ©e**

**Statut actuel** : **Phase 3 prÃªte pour intÃ©gration**

**Prochaine Ã©tape** : **IntÃ©grations composants + Tests end-to-end**

**Temps estimÃ© finalisation** : 1-2 jours pour Phase 3 complÃ¨te

**Architecture** : Solide, rÃ©siliente et extensible

**WebSocket Realtime** : Hooks robustes avec reconnexion automatique

**ğŸ¯ PrÃªt pour finaliser Phase 3 : Synchronisation transcription temps rÃ©el !**

## ğŸ“ˆ Roadmap ComplÃ¨te Mise Ã  Jour

### âœ… **Phase 1-2 : Base & Navigation** (TERMINÃ‰ES)

- Sessions coach/participant
- Auto-recovery & reset appels
- Navigation Whiteboard intÃ©grÃ©e
- SÃ©curitÃ© MUTEX
- APIs robustes Next.js 15

### ğŸ”„ **Phase 3 : Temps RÃ©el** (ARCHITECTURE COMPLÃˆTE - IntÃ©grations en cours)

- âœ… Hooks WebSocket Supabase Realtime
- âœ… Synchronisation position transcription
- âœ… Highlighting + auto-scroll temps rÃ©el
- âœ… Mode spectateur participants
- ğŸ”„ IntÃ©grations composants (4 fichiers)

### â³ **Phase 4 : Interactions** (AprÃ¨s Phase 3 - 2-3 jours)

- Boutons "Toper" participants
- Modal commentaires + critÃ¨res
- Hook `useParticipantEvaluations` (dÃ©jÃ  prÃªt)

### â³ **Phase 5 : Analytics** (Final - 2-3 jours)

- ContrÃ´les objectivitÃ© coach
- Statistiques passages topÃ©s
- Exports et rapports

**ğŸ¯ Timeline rÃ©visÃ© : 2-4 jours pour Phase 3 + 4-6 jours pour Phase 4-5 = 6-10 jours total**
