## üöÄ Impl√©mentation

### Composant Principal RadarEvaluationTab

```tsx
// RadarEvaluationTab.tsx
import React, { useState, useEffect, useMemo } from "react";
import { Box, Typography, Alert, CircularProgress } from "@mui/material";
import { RadarChart } from "./RadarChart";
import { RadarControls } from "./RadarControls";
import { transformPostitsToRadarData } from "./utils";
import { RadarEvaluationTabProps, RadarData } from "./types";

export const RadarEvaluationTab: React.FC<RadarEvaluationTabProps> = ({
  selectedDomain,
  appelPostits,
  categoriesSujets,
  sujetsData,
  selectedCall,
  filters,
}) => {
  const [variant, setVariant] = useState<"multi-level" | "bubbles" | "cloud">(
    "multi-level"
  );
  const [loading, setLoading] = useState(false);

  // Transformation des donn√©es avec useMemo pour optimiser les performances
  const radarData = useMemo(() => {
    if (!selectedDomain || !appelPostits.length || !sujetsData.length) {
      return null;
    }

    console.log("üîÑ Transformation des donn√©es pour le radar");
    console.log("Domaine s√©lectionn√©:", selectedDomain);
    console.log("Post-its disponibles:", appelPostits.length);

    try {
      return transformPostitsToRadarData(
        appelPostits,
        sujetsData,
        categoriesSujets,
        selectedDomain
      );
    } catch (error) {
      console.error("Erreur lors de la transformation:", error);
      return null;
    }
  }, [selectedDomain, appelPostits, sujetsData, categoriesSujets]);

  // Effet pour d√©tecter les changements de domaine
  useEffect(() => {
    console.log("üéØ Domaine s√©lectionn√© chang√©:", selectedDomain);
  }, [selectedDomain]);

  // Gestion du cas o√π aucun domaine n'est s√©lectionn√©
  if (!selectedDomain) {
    return (
      <Box sx={{ p: 3, textAlign: "center" }}>
        <Alert severity="info">
          <Typography variant="body2">
            Veuillez s√©lectionner un domaine dans l'onglet "Synth√®se" pour
            afficher le radar qualit√©.
          </Typography>
        </Alert>
      </Box>
    );
  }

  // Gestion du cas o√π aucune donn√©e n'est disponible
  if (!radarData || radarData.categories.length === 0) {
    return (
      <Box sx={{ p: 3, textAlign: "center" }}>
        <Alert severity="warning">
          <Typography variant="body2">
            Aucune donn√©e d'√©valuation disponible pour ce domaine.
          </Typography>
        </Alert>
      </Box>
    );
  }

  return (
    <Box sx={{ height: "100%", display: "flex", flexDirection: "column" }}>
      {/* En-t√™te avec informations contextuelles */}
      <Box sx={{ mb: 2 }}>
        <Typography variant="h6" sx={{ mb: 1, color: "primary.main" }}>
          Radar Qualit√© - {radarData.domainName}
        </Typography>
        <Typography variant="body2" color="text.secondary">
          Appel #{selectedCall.callid} ‚Ä¢ {radarData.totalSubjects} crit√®res
          √©valu√©s
        </Typography>
      </Box>

      {/* Contr√¥les du radar */}
      <RadarControls
        variant={variant}
        onVariantChange={setVariant}
        data={radarData}
      />

      {/* Composant radar principal */}
      <Box
        sx={{
          flexGrow: 1,
          display: "flex",
          justifyContent: "center",
          alignItems: "center",
        }}
      >
        {loading ? (
          <CircularProgress />
        ) : (
          <RadarChart
            data={radarData}
            variant={variant}
            width={600}
            height={600}
            onSubjectClick={(subject) => {
              console.log("Clic sur sujet:", subject.name);
              // Ici on peut impl√©menter la navigation vers les post-its li√©s
            }}
          />
        )}
      </Box>

      {/* L√©gende et statistiques */}
      {radarData && (
        <Box sx={{ mt: 2, p: 2, bgcolor: "grey.50", borderRadius: 1 }}>
          <Typography variant="caption" color="text.secondary">
            üî¥ Non conforme ({radarData.stats.nonConforme}) ‚Ä¢ üü° Partiellement
            conforme ({radarData.stats.partiel}) ‚Ä¢ üü¢ Conforme (
            {radarData.stats.conforme})
          </Typography>
        </Box>
      )}
    </Box>
  );
};
```

### Int√©gration dans SyntheseEvaluation

```tsx
// Modifications dans SyntheseEvaluation.tsx

// 1. Import du nouveau composant
import RadarEvaluationTab from './RadarEvaluationTab';
import { RadarChart as RadarChartIcon } from '@mui/icons-material';

// 2. Ajout de l'onglet dans la navigation
<Tabs value={activeTab} onChange={...}>
  <Tab label="SYNTH√àSE" />
  <Tab label="CRIT√àRES QUALIT√â" />
  <Tab label="SIMULATION COACHING" />
  <Tab
    icon={!isMobile ? <RadarChartIcon fontSize="small" /> : undefined}
    iconPosition="start"
    label="RADAR QUALIT√â"
  />
</Tabs>

// 3. Ajout du contenu de l'onglet
{activeTab === 3 && (
  <RadarEvaluationTab
    selectedDomain={domainAsNumber}
    appelPostits={convertedPostits}
    categoriesSujets={categoriesSujets}
    sujetsData={sujetsData}
    selectedCall={convertedCall}
    filters={{
      entreprise: /* r√©cup√©rer depuis le contexte ou les props */,
      conseiller: /* r√©cup√©rer depuis le contexte ou les props */,
      appel: selectedCall.callid
    }}
  />
)}
```

### Fonction de Transformation des Donn√©es

```typescript
// utils/transformPostitsToRadarData.ts
import { EvaluationPostit, RadarData, RadarSubject } from "./types";

export const transformPostitsToRadarData = (
  appelPostits: EvaluationPostit[],
  sujetsData: any[],
  categoriesSujets: any[],
  selectedDomain: number
): RadarData => {
  console.log("üîÑ D√©but transformation radar data");
  console.log("Posts-its:", appelPostits.length);
  console.log("Domaine s√©lectionn√©:", selectedDomain);

  // 1. Filtrer les post-its du domaine s√©lectionn√©
  const domainPostits = appelPostits.filter(
    (p) => p.iddomaine === selectedDomain
  );
  console.log("Post-its du domaine:", domainPostits.length);

  // 2. R√©cup√©rer tous les sujets du domaine (conformes ET non-conformes)
  const domainSujets = sujetsData.filter((s) => s.iddomaine === selectedDomain);
  console.log("Sujets du domaine:", domainSujets.length);

  // 3. Cr√©er un Set des sujets ayant des post-its (non-conformes)
  const nonConformeSujetIds = new Set(
    domainPostits.filter((p) => p.idsujet != null).map((p) => p.idsujet)
  );

  // 4. Transformer chaque sujet en donn√©es radar
  const radarSubjects: RadarSubject[] = domainSujets.map((sujet) => {
    const isNonConforme = nonConformeSujetIds.has(sujet.idsujet);
    const sujetPostits = domainPostits.filter(
      (p) => p.idsujet === sujet.idsujet
    );

    // Logique m√©tier corrig√©e : pr√©sence = non-conforme, absence = conforme
    const nonConformityCount = sujetPostits.length;
    const nonConformityRate = isNonConforme
      ? Math.min(nonConformityCount / 5, 1)
      : 0; // Ajuster le diviseur selon le contexte

    const status =
      nonConformityRate === 0
        ? "conforme"
        : nonConformityRate < 0.3
          ? "partiellement_conforme"
          : "non_conforme";

    // R√©cup√©rer les informations de cat√©gorie
    const categorie = categoriesSujets.find(
      (c) => c.idcategoriesujet === sujet.idcategoriesujet
    );

    return {
      id: sujet.idsujet,
      name: sujet.nomsujet,
      nonConformityRate,
      nonConformityCount,
      totalEvaluations: 1, // Ou calcul√© selon la logique m√©tier
      status,
      categoryId: sujet.idcategoriesujet,
      categoryName: categorie?.nomcategorie || "Non cat√©goris√©",
      categoryColor: categorie?.couleur || "#666",
      relatedPostits: sujetPostits,
    };
  });

  // 5. Grouper par cat√©gories et calculer les angles
  const categories = categoriesSujets
    .filter((cat) =>
      radarSubjects.some((s) => s.categoryId === cat.idcategoriesujet)
    )
    .map((cat, index, array) => {
      const categorySubjects = radarSubjects.filter(
        (s) => s.categoryId === cat.idcategoriesujet
      );
      const angle = (index / array.length) * 2 * Math.PI;

      return {
        id: cat.idcategoriesujet,
        name: cat.nomcategorie,
        color: cat.couleur || "#666",
        angle,
        subjects: categorySubjects,
      };
    });

  // 6. Calculer les statistiques globales
  const stats = {
    conforme: radarSubjects.filter((s) => s.status === "conforme").length,
    partiel: radarSubjects.filter((s) => s.status === "partiellement_conforme")
      .length,
    nonConforme: radarSubjects.filter((s) => s.status === "non_conforme")
      .length,
    totalSubjects: radarSubjects.length,
  };

  const result: RadarData = {
    domainId: selectedDomain,
    domainName: `Domaine ${selectedDomain}`, // √Ä r√©cup√©rer depuis les donn√©es si disponible
    categories,
    stats,
    totalSubjects: radarSubjects.length,
  };

  console.log("‚úÖ Transformation termin√©e:", result);
  return result;
};
```

### Types Sp√©cifiques au Radar

````typescript
// types/radar.types.ts
export interface RadarData {
  domainId: number;
  domainName: string;
  categories: RadarCategory[];
  stats: RadarStats;
  totalSubjects: number;
}

export interface RadarCategory {
  id: number;
  name: string;
  color: string;
  angle: number;
  subjects: RadarSubject[];
}

export interface RadarSubject {
  id: number;
  name: string;
  nonConformityRate: number;      // 0-1
  nonConformityCount: number;     // Nombre de post-its
  totalEvaluations: number;       // Volume d'√©valuations
  status: 'conforme' | 'partiellement_conforme' | 'non_conforme';
  categoryId: number;
  categoryName: string;
  categoryColor: string;
  relatedPostits: EvaluationPostit[];
}

export interface RadarStats {
  conforme: number;
  partiel: number;
  nonConforme: number;
  totalSubjects: number;
}

export interface RadarEvaluationTabProps {
  selectedDomain: number | null;
  appelPostits: EvaluationPostit[];
  categoriesSujets: any[];
  sujetsData: any[];
  selectedCall: any;
  filters?: {
    entreprise?: number;
    conseiller?: number;
    appel?: number;
  };
}
```filter(s => s.status === 'non_conforme').length
      }
    }))
  }));

  return {
    domains,
    filters: {},
    metadata: {
      lastUpdate: new Date(),
      totalDomains: domains.length,
      totalSubjects: domains.reduce((sum, d) => sum + d.categories.reduce((cSum, c) => cSum + c.subjects.length, 0), 0)
    }
  };
};

const calculateDomainAngle = (domainId: number): number => {
  const angles = [0, 2 * Math.PI / 3, 4 * Math.PI / 3];
  return angles[(domainId - 1) % angles.length] || 0;
};
````

### Fonction SQL Supabase

```sql
-- Cr√©er la fonction RPC dans Supabase
CREATE OR REPLACE FUNCTION get_non_conformity_summary(
  conseiller_id INT DEFAULT NULL,
  entreprise_id INT DEFAULT NULL,
  date_debut DATE DEFAULT NULL,
  date_fin DATE DEFAULT NULL
)
RETURNS TABLE (
  iddomaine INT,
  nomdomaine TEXT,
  idcategoriesujet INT,
  nomcategorie VARCHAR(255),
  couleur VARCHAR(7),
  idsujet INT,
  nomsujet TEXT,
  total_evaluations BIGINT,
  non_conformity_count BIGINT,
  non_conformity_rate FLOAT,
  status TEXT
) AS $
BEGIN
  RETURN QUERY
  WITH non_conformity_data AS (
    SELECT
      d.iddomaine,
      d.nomdomaine,
      cs.idcategoriesujet,
      cs.nomcategorie,
      cs.couleur,
      s.idsujet,
      s.nomsujet,
      COUNT(DISTINCT ac.idactivite) as total_evals,
      COUNT(DISTINCT acs.idactivite) as non_conf_count,
      CASE
        WHEN COUNT(DISTINCT ac.idactivite) > 0
        THEN COUNT(DISTINCT acs.idactivite)::float / COUNT(DISTINCT ac.idactivite)::float
        ELSE 0::float
      END as non_conf_rate
    FROM domaines d
    JOIN sujets s ON d.iddomaine = s.iddomaine
    JOIN categoriessujets cs ON s.idcategoriesujet = cs.idcategoriesujet
    LEFT JOIN activitesconseillers ac ON TRUE
    LEFT JOIN activitesconseillers_sujets acs ON (s.idsujet = acs.idsujet AND ac.idactivite = acs.idactivite)
    WHERE (conseiller_id IS NULL OR ac.idconseiller = conseiller_id)
      AND (entreprise_id IS NULL OR EXISTS (
        SELECT 1 FROM conseillers c
        WHERE c.idconseiller = ac.idconseiller
        AND c.entreprise = entreprise_id
      ))
      AND (date_debut IS NULL OR ac.dateactivite >= date_debut)
      AND (date_fin IS NULL OR ac.dateactivite <= date_fin)
    GROUP BY d.iddomaine, d.nomdomaine, cs.idcategoriesujet, cs.nomcategorie, cs.couleur, s.idsujet, s.nomsujet
  )
  SELECT
    ncd.*,
    CASE
      WHEN ncd.non_conf_rate = 0 THEN 'conforme'::TEXT
      WHEN ncd.non_conf_rate < 0.3 THEN 'partiellement_conforme'::TEXT
      ELSE 'non_conforme'::TEXT
    END as status
  FROM non_conformity_data ncd
  ORDER BY ncd.iddomaine, ncd.idcategoriesujet, ncd.non_conf_rate DESC;
END;
$ LANGUAGE plpgsql;
```

## üß™ Jeu de Tests Complet

### Sc√©narios de Test

```typescript
// test-scenarios.ts
export const testScenarios = {
  // Sc√©nario 1: Conseiller junior avec beaucoup de probl√®mes
  juniorAdvisor: {
    filters: { conseiller: 102, entreprise: 1 },
    expectedPatterns: {
      distanceFromCenter: "high", // Points √©loign√©s du centre
      clusteredProblems: ["communication", "diagnostic", "dossier_client"],
      conformeAreas: ["ecoute_active", "rgpd"],
    },
  },

  // Sc√©nario 2: Conseiller expert avec peu de probl√®mes
  expertAdvisor: {
    filters: { conseiller: 103, entreprise: 1 },
    expectedPatterns: {
      distanceFromCenter: "low", // Points pr√®s du centre
      scatteredProblems: ["occasional_issues"],
      conformeAreas: ["most_subjects"],
    },
  },

  // Sc√©nario 3: Comparaison d'entreprises
  enterpriseComparison: {
    filters: { entreprise: 1 }, // vs entreprise: 2
    expectedDifferences: {
      techcorp: "communication_problems",
      conseilPlus: "technical_problems",
    },
  },

  // Sc√©nario 4: √âvolution temporelle
  timeEvolution: {
    filters: {
      dateRange: [new Date("2024-01-01"), new Date("2024-01-31")],
    },
    expectedTrends: {
      improving: ["ecoute_active", "alternatives"],
      deteriorating: ["accueil_telephonique", "mise_a_jour"],
    },
  },
};
```

### G√©n√©rateur de Donn√©es de Test

```typescript
// test-data-generator.ts
export const generateTestData = (scenario: string, multipliers: any = {}) => {
  const baseData = JSON.parse(JSON.stringify(testData)); // Deep clone

  // Appliquer les multiplicateurs selon le sc√©nario
  baseData.domains.forEach((domain) => {
    const domainMultiplier =
      multipliers[domain.name.toLowerCase().replace(/\s+/g, "_")] || 1;

    domain.categories.forEach((category) => {
      category.subjects.forEach((subject) => {
        // Ajuster les taux de non-conformit√©
        subject.nonConformityRate = Math.min(
          0.95,
          subject.nonConformityRate * domainMultiplier
        );
        subject.nonConformityCount = Math.round(
          subject.nonConformityCount * domainMultiplier
        );

        // Recalculer le statut
        if (subject.nonConformityRate === 0) {
          subject.status = "conforme";
        } else if (subject.nonConformityRate < 0.3) {
          subject.status = "partiellement_conforme";
        } else {
          subject.status = "non_conforme";
        }
      });
    });
  });

  return baseData;
};
```

### Tests Unitaires

```typescript
// RadarEvaluation.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { RadarEvaluation } from './RadarEvaluation';
import { testScenarios, generateTestData } from './test-data-generator';

describe('RadarEvaluation', () => {
  it('should display non-conformities farther from center', () => {
    const testData = generateTestData('juniorAdvisor', testScenarios.juniorAdvisor.multipliers);

    render(<RadarEvaluation data={testData} />);

    // V√©rifier que les points non-conformes sont √©loign√©s du centre
    const nonConformePoints = screen.getAllByTestId(/subject-point-non_conforme/);
    expect(nonConformePoints.length).toBeGreaterThan(0);

    // V√©rifier que les points conformes sont pr√®s du centre
    const conformePoints = screen.getAllByTestId(/subject-point-conforme/);
    expect(conformePoints.length).toBeGreaterThan(0);
  });

  it('should filter by enterprise correctly', async () => {
    render(<RadarEvaluation />);

    const enterpriseFilter = screen.getByLabelText('Entreprise');
    fireEvent.change(enterpriseFilter, { target: { value: '1' } });

    // V√©rifier que seules les donn√©es de l'entreprise 1 sont affich√©es
    await screen.findByText('TechCorp Solutions');
    expect(screen.queryByText('Conseil Plus')).not.toBeInTheDocument();
  });

  it('should handle drill-down interaction', () => {
    const testData = generateTestData('expertAdvisor');
    render(<RadarEvaluation data={testData} />);

    // Cliquer sur un domaine
    const domainButton = screen.getByText('Relation Client');
    fireEvent.click(domainButton);

    // V√©rifier que les cat√©gories sont affich√©es
    expect(screen.getByText('Communication')).toBeInTheDocument();
    expect(screen.getByText('R√©solution')).toBeInTheDocument();
  });
});
```

## üì¶ D√©pendances

```json
{
  "dependencies": {
    "react": "^18.0.0",
    "d3": "^7.8.5",
    "@supabase/supabase-js": "^2.38.0",
    "typescript": "^5.0.0"
  },
  "devDependencies": {
    "@testing-library/react": "^13.4.0",
    "@testing-library/jest-dom": "^5.16.5",
    "@types/d3": "^7.4.0",
    "jest": "^29.0.0"
  }
}
```

## üöÄ D√©marrage Rapide

1. **Installation**

```bash
npm install d3 @supabase/supabase-js
```

2. **Configuration Supabase**

```typescript
// supabase-client.ts
import { createClient } from "@supabase/supabase-js";

const supabaseUrl = "YOUR_SUPABASE_URL";
const supabaseKey = "YOUR_SUPABASE_ANON_KEY";

export const supabase = createClient(supabaseUrl, supabaseKey);
```

3. **Utilisation**

```tsx
import { RadarEvaluation } from "./components/RadarEvaluation";

function App() {
  return (
    <RadarEvaluation variant="multi-level" initialFilters={{ entreprise: 1 }} />
  );
}
```

## üìà M√©triques de Performance

- **Temps de chargement cible** : < 2 secondes
- **Donn√©es support√©es** : Jusqu'√† 1000 √©valuations simultan√©es
- **Interactions fluides** : 60 FPS pour les animations
- **Responsive** : Support mobile et desktop

## üîß Personnalisation

### Th√®mes de Couleurs

```css
/* Th√®me par d√©faut - Focus sur les probl√®mes */
:root {
  --radar-conforme: #4caf50;
  --radar-partiel: #ff9800;
  --radar-non-conforme: #f44336;
  --radar-critique: #d32f2f;
}

/* Th√®me alternatif - Plus doux */
:root {
  --radar-conforme: #81c784;
  --radar-partiel: #ffb74d;
  --radar-non-conforme: #e57373;
  --radar-critique: #f44336;
}
```

Cette documentation fournit tout le n√©cessaire pour d√©velopper le composant radar dans une nouvelle session Claude. La logique m√©tier corrig√©e met bien l'accent sur la visualisation des **non-conformit√©s** comme indicateur de probl√®mes √† r√©soudre.# Composant de Visualisation Radar - Donn√©es d'√âvaluation

## üìã Contexte du Projet

Ce composant permet de visualiser les donn√©es d'√©valuation de conseillers avec une approche radar am√©lior√©e. Il s'int√®gre dans un syst√®me existant utilisant Supabase avec les sch√©mas `public` et `whiteboard`.

### Structure des Donn√©es Source (Supabase)

```sql
-- Tables principales d'√©valuation
activitesconseillers (idactivite, idconseiller, idsujet, idpratique, idexercice, dateactivite, statut...)
activitesconseillers_sujets (idactivite, idsujet, travaille, note_conformite)
activitesconseillers_pratiques (idactivite, idpratique, travaille)
ponderation_sujets (idsujet, conforme, partiellement_conforme, non_conforme)

-- Tables de r√©f√©rence
domaines (iddomaine, nomdomaine, description)
categoriessujets (idcategoriesujet, nomcategorie, couleur)
sujets (idsujet, iddomaine, nomsujet, idcategoriesujet)
conseillers (idconseiller, nom, prenom, entreprise)
entreprises (identreprise, nomentreprise)
```

## üéØ Objectifs du Composant

1. **Visualiser les sujets non-conformes** lors d'activit√©s de conseil
2. **Drill-down hi√©rarchique** : Domaine ‚Üí Cat√©gorie ‚Üí Sujets
3. **Filtrage** par entreprise, conseiller, et appel
4. **Repr√©sentation spatiale innovante** avec radar am√©lior√©
5. **Int√©gration dans SyntheseEvaluation** comme nouvel onglet

### Logique M√©tier

- **Si `idsujet` et `idactivite` sont li√©s dans `activitesconseillers_sujets`** ‚Üí le sujet a √©t√© jug√© **NON CONFORME**
- **Si absence de liaison** ‚Üí le sujet est par d√©faut √©valu√© et jug√© **CONFORME**
- **Ce qui est repr√©sent√©** = la **NON-CONFORMIT√â** (pr√©sence = probl√®me)
- Distance du centre = niveau de non-conformit√© (plus loin = plus de probl√®mes)
- Taille des points = volume/gravit√© des non-conformit√©s

## üõ† Sp√©cifications Techniques

### Architecture Recommand√©e

```
components/
‚îú‚îÄ‚îÄ RadarEvaluation/
‚îÇ   ‚îú‚îÄ‚îÄ RadarEvaluationTab.tsx        # Composant principal pour l'onglet
‚îÇ   ‚îú‚îÄ‚îÄ RadarChart.tsx                # Logique de rendu D3
‚îÇ   ‚îú‚îÄ‚îÄ RadarControls.tsx             # Filtres et contr√¥les
‚îÇ   ‚îú‚îÄ‚îÄ RadarTooltip.tsx              # Infobulles d√©taill√©es
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                      # Types TypeScript
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts                      # Fonctions utilitaires
‚îÇ   ‚îî‚îÄ‚îÄ radar.styles.css              # Styles CSS
‚îú‚îÄ‚îÄ SyntheseEvaluation.tsx            # Composant parent existant
‚îú‚îÄ‚îÄ SyntheseTab.tsx                   # Onglet synth√®se existant
‚îú‚îÄ‚îÄ CritereQualiteTab.tsx             # Onglet crit√®res existant
‚îî‚îÄ‚îÄ SimulationCoachingTab.tsx         # Onglet coaching existant
```

## üèó Int√©gration dans SyntheseEvaluation

### Structure Existante Analys√©e

Le composant `SyntheseEvaluation` contient d√©j√† :

- **3 onglets** : Synth√®se, Crit√®res Qualit√©, Simulation Coaching
- **Syst√®me de filtrage** par domaine, conseiller, entreprise
- **Donn√©es disponibles** : `appelPostits`, `selectedCall`, `sujetsData`, `categoriesSujets`
- **Contextes** : `useCallData()`, `useAppContext()`, `useSupabase()`

### Nouvel Onglet Radar

**Ajout d'un 4√®me onglet "RADAR QUALIT√â"** dans `SyntheseEvaluation.tsx` :

```tsx
// Dans SyntheseEvaluation.tsx - Ajout de l'onglet
<Tab
  icon={!isMobile ? <RadarChartIcon fontSize="small" /> : undefined}
  iconPosition="start"
  label="RADAR QUALIT√â"
/>

// Dans le contenu des onglets
{activeTab === 3 && (
  <RadarEvaluationTab
    selectedDomain={domainAsNumber}
    appelPostits={convertedPostits}
    categoriesSujets={categoriesSujets}
    sujetsData={sujetsData}
    selectedCall={convertedCall}
    filters={{
      entreprise: /* r√©cup√©rer depuis le contexte */,
      conseiller: /* r√©cup√©rer depuis le contexte */,
      appel: selectedCall.callid
    }}
  />
)}
```

### Props √† Recevoir du Parent

```typescript
interface RadarEvaluationTabProps {
  selectedDomain: number | null;
  appelPostits: EvaluationPostit[];
  categoriesSujets: any[];
  sujetsData: any[];
  selectedCall: EvaluationCall;
  filters: {
    entreprise?: number;
    conseiller?: number;
    appel?: number;
  };
}
```

### Logique de Donn√©es √† Impl√©menter

1. **R√©cup√©ration automatique des domaines** depuis `appelPostits`
2. **Calcul des non-conformit√©s** bas√© sur la pr√©sence dans `appelPostits`
3. **Utilisation du domaine s√©lectionn√©** depuis `useAppContext().selectedDomain`
4. **Transformation des donn√©es** selon la logique m√©tier corrig√©e

## üìä Mod√®le de Donn√©es

### Donn√©es Disponibles depuis SyntheseEvaluation

```typescript
// Donn√©es re√ßues du composant parent
interface RadarEvaluationTabProps {
  selectedDomain: number | null; // Domaine s√©lectionn√© dans le contexte
  appelPostits: EvaluationPostit[]; // Post-its de l'appel en cours
  categoriesSujets: any[]; // Cat√©gories des sujets avec couleurs
  sujetsData: any[]; // Donn√©es compl√®tes des sujets
  selectedCall: EvaluationCall; // Appel s√©lectionn√©
  filters: FilterOptions; // Filtres appliqu√©s
}

// Structure des post-its (donn√©es source)
interface EvaluationPostit {
  id: string;
  callid: number;
  wordid: number;
  word: string;
  text: string;
  iddomaine?: number; // Domaine du post-it
  sujet?: string; // Nom du sujet (si √©valu√©)
  idsujet?: number; // ID du sujet (si √©valu√©)
  pratique?: string; // Nom de la pratique
  timestamp: number; // Position temporelle
  idactivite?: number; // ID de l'activit√©
}

// Structure transform√©e pour le radar
interface RadarSubject {
  id: number;
  name: string;
  nonConformityRate: number; // 0-1 calcul√© depuis les post-its
  nonConformityCount: number; // Nombre de post-its pour ce sujet
  totalEvaluations: number; // Volume total d'√©valuations possibles
  status: NonConformityStatus; // Statut calcul√©
  categoryId: number; // Pour regroupement
  categoryColor: string; // Couleur de la cat√©gorie
  relatedPostits: EvaluationPostit[]; // Post-its li√©s √† ce sujet
}
```

### Logique de Transformation des Donn√©es

```typescript
// Fonction de transformation principale
const transformPostitsToRadarData = (
  appelPostits: EvaluationPostit[],
  sujetsData: any[],
  categoriesSujets: any[],
  selectedDomain: number
): RadarData => {
  // 1. Filtrer les post-its du domaine s√©lectionn√©
  const domainPostits = appelPostits.filter(
    (p) => p.iddomaine === selectedDomain
  );

  // 2. R√©cup√©rer tous les sujets du domaine
  const domainSujets = sujetsData.filter((s) => s.iddomaine === selectedDomain);

  // 3. Pour chaque sujet du domaine
  const radarSubjects = domainSujets.map((sujet) => {
    // Compter les post-its (non-conformit√©s) pour ce sujet
    const sujetPostits = domainPostits.filter(
      (p) => p.idsujet === sujet.idsujet
    );
    const nonConformityCount = sujetPostits.length;

    // Calculer le taux de non-conformit√©
    // Ici on peut d√©finir une logique bas√©e sur le volume total d'√©valuations
    // ou utiliser un seuil fixe pour d√©terminer le taux
    const nonConformityRate =
      nonConformityCount > 0 ? Math.min(nonConformityCount / 10, 1) : 0; // Exemple de calcul

    // D√©terminer le statut
    const status =
      nonConformityRate === 0
        ? "conforme"
        : nonConformityRate < 0.3
          ? "partiellement_conforme"
          : "non_conforme";

    // R√©cup√©rer la couleur de la cat√©gorie
    const categorie = categoriesSujets.find(
      (c) => c.idcategoriesujet === sujet.idcategoriesujet
    );

    return {
      id: sujet.idsujet,
      name: sujet.nomsujet,
      nonConformityRate,
      nonConformityCount,
      totalEvaluations: nonConformityCount, // √Ä ajuster selon la logique m√©tier
      status,
      categoryId: sujet.idcategoriesujet,
      categoryColor: categorie?.couleur || "#666",
      relatedPostits: sujetPostits,
    };
  });

  // 4. Grouper par cat√©gories pour le radar
  return groupSubjectsByCategory(radarSubjects, categoriesSujets);
};
```

````

### Requ√™tes Supabase Recommand√©es

```sql
-- 1. R√©cup√©rer les non-conformit√©s par sujet (logique corrig√©e)
WITH non_conformity_summary AS (
  SELECT
    d.iddomaine,
    d.nomdomaine,
    cs.idcategoriesujet,
    cs.nomcategorie,
    cs.couleur,
    s.idsujet,
    s.nomsujet,
    -- Compter le total d'√©valuations pour ce sujet
    COUNT(DISTINCT ac.idactivite) as total_evaluations,
    -- Compter les non-conformit√©s (pr√©sence dans activitesconseillers_sujets)
    COUNT(DISTINCT acs.idactivite) as non_conformity_count,
    -- Calculer le taux de non-conformit√©
    CASE
      WHEN COUNT(DISTINCT ac.idactivite) > 0
      THEN COUNT(DISTINCT acs.idactivite)::float / COUNT(DISTINCT ac.idactivite)::float
      ELSE 0
    END as non_conformity_rate
  FROM domaines d
  JOIN sujets s ON d.iddomaine = s.iddomaine
  JOIN categoriessujets cs ON s.idcategoriesujet = cs.idcategoriesujet
  -- Toutes les activit√©s o√π ce sujet aurait pu √™tre √©valu√©
  LEFT JOIN activitesconseillers ac ON ac.idsujet = s.idsujet OR ac.idsujet IS NULL
  -- Seulement les non-conformit√©s r√©elles (pr√©sence = probl√®me)
  LEFT JOIN activitesconseillers_sujets acs ON s.idsujet = acs.idsujet AND ac.idactivite = acs.idactivite
  WHERE ($1::int IS NULL OR ac.idconseiller = $1)
    AND ($2::int IS NULL OR EXISTS (
      SELECT 1 FROM conseillers c
      WHERE c.idconseiller = ac.idconseiller
      AND c.entreprise = $2
    ))
  GROUP BY d.iddomaine, d.nomdomaine, cs.idcategoriesujet, cs.nomcategorie, cs.couleur, s.idsujet, s.nomsujet
)
SELECT
  *,
  CASE
    WHEN non_conformity_rate = 0 THEN 'conforme'
    WHEN non_conformity_rate < 0.3 THEN 'partiellement_conforme'
    ELSE 'non_conforme'
  END as status
FROM non_conformity_summary
ORDER BY iddomaine, idcategoriesujet, non_conformity_rate DESC;

-- 2. Statistiques d'entreprises avec focus sur les probl√®mes
SELECT
  e.identreprise,
  e.nomentreprise,
  COUNT(DISTINCT c.idconseiller) as nb_conseillers,
  COUNT(DISTINCT ac.idactivite) as nb_evaluations,
  COUNT(DISTINCT acs.idactivite) as nb_non_conformities,
  ROUND(
    COUNT(DISTINCT acs.idactivite)::float /
    NULLIF(COUNT(DISTINCT ac.idactivite), 0)::float * 100,
    2
  ) as taux_non_conformite_pct
FROM entreprises e
JOIN conseillers c ON e.identreprise = c.entreprise
LEFT JOIN activitesconseillers ac ON c.idconseiller = ac.idconseiller
LEFT JOIN activitesconseillers_sujets acs ON ac.idactivite = acs.idactivite
GROUP BY e.identreprise, e.nomentreprise
ORDER BY taux_non_conformite_pct DESC;
````

## üé® Variantes de Radar Recommand√©es

### 1. Radar Multi-Niveaux (Recommand√© Principal)

```javascript
// Logique de positionnement - Plus loin du centre = Plus de non-conformit√©s
const positionPoint = (subject, category, domain) => {
  const categoryRadius = maxRadius * (0.4 + category.level * 0.3);
  // Distance bas√©e sur le taux de non-conformit√© (0 = centre, 1 = bord)
  const nonConformityDistance =
    categoryRadius * (0.2 + subject.nonConformityRate * 0.8);
  const angle = domain.angle + getAngleOffset(subject, category);

  return {
    x: centerX + Math.cos(angle - Math.PI / 2) * nonConformityDistance,
    y: centerY + Math.sin(angle - Math.PI / 2) * nonConformityDistance,
    // Taille bas√©e sur le nombre absolu de non-conformit√©s
    radius: 4 + Math.sqrt(subject.nonConformityCount),
  };
};
```

### 2. Radar √† Bulles Hi√©rarchiques

```javascript
// Agr√©gation par cat√©gorie - Focus sur les non-conformit√©s
const aggregateCategory = (category) => {
  const subjects = category.subjects;
  const totalNonConformities = subjects.reduce(
    (sum, s) => sum + s.nonConformityCount,
    0
  );
  const totalEvaluations = subjects.reduce(
    (sum, s) => sum + s.totalEvaluations,
    0
  );

  return {
    avgNonConformityRate:
      subjects.reduce((sum, s) => sum + s.nonConformityRate, 0) /
      subjects.length,
    totalNonConformities: totalNonConformities,
    totalVolume: totalEvaluations,
    criticalSubjects: subjects.filter((s) => s.status === "non_conforme")
      .length,
    // Score de criticit√© pour le positionnement
    criticalityScore: totalNonConformities / Math.max(totalEvaluations, 1),
  };
};
```

### 3. Configuration des Couleurs

```css
:root {
  --color-conforme: #4caf50;
  --color-partiel: #ff9800;
  --color-non-conforme: #f44336;
  --color-background: #fafafa;
  --color-grid: #e0e0e0;
  --color-axis: #999;
}
```

## üß™ Donn√©es de Test

### Jeu de Donn√©es Complet

```json
{
  "testData": {
    "enterprises": [
      {
        "id": 1,
        "name": "TechCorp Solutions",
        "advisors": [
          {"id": 101, "name": "Marie Dubois", "experience": "senior"},
          {"id": 102, "name": "Jean Martin", "experience": "junior"},
          {"id": 103, "name": "Sophie Bernard", "experience": "expert"}
        ]
      },
      {
        "id": 2,
        "name": "Conseil Plus",
        "advisors": [
          {"id": 201, "name": "Pierre Durand", "experience": "senior"},
          {"id": 202, "name": "Julie Moreau", "experience": "junior"}
        ]
      }
    ],
    "domains": [
      {
        "id": 1,
        "name": "Relation Client",
        "angle": 0,
        "categories": [
          {
            "id": 11,
            "name": "Communication",
            "color": "#2196F3",
            "subjects": [
              {
                "id": 111,
                "name": "Accueil t√©l√©phonique",
                "nonConformityRate": 0.7,     // 70% des √©valuations sont non conformes
                "nonConformityCount": 15,     // 15 non-conformit√©s d√©tect√©es
                "totalEvaluations": 22,       // Sur 22 √©valuations totales
                "status": "non_conforme",
                "lastEvaluation": "2024-01-15",
                "details": {
                  "commonIssues": ["Ton inappropri√©", "Absence de formule de politesse", "Interruption client"],
                  "severity": "high",
                  "trend": "declining"
                }
              },
              {
                "id": 112,
                "name": "√âcoute active",
                "nonConformityRate": 0.08,    // 8% des √©valuations sont non conformes
                "nonConformityCount": 3,      // 3 non-conformit√©s d√©tect√©es
                "totalEvaluations": 38,       // Sur 38 √©valuations totales
                "status": "conforme",
                "lastEvaluation": "2024-01-14",
                "details": {
                  "commonIssues": ["Reformulation incompl√®te"],
                  "severity": "low",
                  "trend": "stable"
                }
              },
              {
                "id": 113,
                "name": "Reformulation",
                "nonConformityRate": 0.29,    // 29% des √©valuations sont non conformes
                "nonConformityCount": 12,
                "totalEvaluations": 42,
                "status": "partiellement_conforme",
                "lastEvaluation": "2024-01-13"
              },
              {
                "id": 114,
                "name": "Langage adapt√©",
                "nonConformityRate": 0.06,    // 6% des √©valuations sont non conformes
                "nonConformityCount": 2,
                "totalEvaluations": 35,
                "status": "conforme",
                "lastEvaluation": "2024-01-12"
              }
            ]
          },
          {
            "id": 12,
            "name": "R√©solution",
            "color": "#03A9F4
```
