# ğŸ“‹ Phase 3 - SpÃ©cification Technique DÃ©taillÃ©e

## ğŸ¯ Objectif Global

Permettre aux participants de voir **exactement la mÃªme chose** que le coach dans Evaluation, mais en mode **spectateur synchronisÃ©** temps rÃ©el.

## âœ… PrÃ©requis ValidÃ©s

### Service Role Permissions âœ…

Les permissions Supabase sont configurÃ©es pour permettre aux participants non-authentifiÃ©s d'accÃ©der aux donnÃ©es :

```sql
GRANT SELECT ON public.call TO service_role;     -- âœ… ConfirmÃ©
GRANT SELECT ON public.word TO service_role;     -- âœ… ConfirmÃ©
```

**Status** : âœ… Permissions actives, participants peuvent rÃ©cupÃ©rer transcription et audio

### Extension Table BDD âœ…

```sql
-- âœ… EXÃ‰CUTÃ‰ : Extension shared_evaluation_sessions
ALTER TABLE whiteboard.shared_evaluation_sessions
ADD COLUMN view_mode VARCHAR(20) DEFAULT 'word',
ADD COLUMN current_word_index INTEGER DEFAULT 0,
ADD COLUMN current_paragraph_index INTEGER DEFAULT 0,
ADD COLUMN highlight_turn_one BOOLEAN DEFAULT false,
ADD COLUMN highlight_speakers BOOLEAN DEFAULT true;
```

**Status** : âœ… Table Ã©tendue, prÃªte pour synchronisation highlighting

### Hooks et API Existants âœ…

- âœ… `useCallData()` : RÃ©cupÃ©ration transcription + audioUrl
- âœ… `useTranscriptions()` : Compatible service role
- âœ… `createAudioUrlWithToken()` : GÃ©nÃ©ration URL signÃ©e audio
- âœ… Middleware : Routes API hybrides auth + service role

## ğŸ—ºï¸ Mapping Evaluation â†’ Whiteboard

### 1. Zone Coach (Evaluation) â†’ Zone Participants (Whiteboard)

| Composant Evaluation        | Composant Whiteboard        | Ã‰tat         | Notes                              |
| --------------------------- | --------------------------- | ------------ | ---------------------------------- |
| `TranscriptionHeader`       | `SharedEvaluationHeader`    | âœ… Ã€ crÃ©er   | Header simplifiÃ© pour participants |
| `Transcript.tsx`            | `SynchronizedTranscript`    | âœ… Ã€ adapter | Mode word synchronisÃ©              |
| `TranscriptAlternative.tsx` | `SynchronizedTranscriptAlt` | âœ… Ã€ adapter | Mode paragraph synchronisÃ©         |
| `AudioPlayer`               | `SynchronizedAudioPlayer`   | âœ… Ã€ adapter | Lecteur spectateur                 |
| `AddPostitButton`           | `TopButton`                 | ğŸ”œ Phase 4   | Boutons "Toper" participants       |

### 2. DonnÃ©es SynchronisÃ©es Temps RÃ©el

| DonnÃ©e Coach                   | Synchronisation | Effet Participants                                     |
| ------------------------------ | --------------- | ------------------------------------------------------ |
| `viewMode`("word"/"paragraph") | WebSocket       | Switch automatique Transcript â†” TranscriptAlternative |
| `currentWordIndex`             | WebSocket       | Highlighting mot/segment en cours                      |
| `currentTime`audio             | WebSocket       | Position timeline synchronisÃ©e                         |
| `isPlaying`                    | WebSocket       | Ã‰tat play/pause lecteur                                |
| `highlightTurnOne`             | WebSocket       | Coloration tours de parole                             |
| `highlightSpeakers`            | WebSocket       | Coloration locuteurs                                   |

## ğŸš€ StratÃ©gie de DÃ©veloppement

### Phase 3A : Adaptation des Composants Existants (1 jour)

#### 1. âœ… Hook Participant Evaluations (Phase 4 Ready)

```typescript
// âœ… CRÃ‰Ã‰ : useParticipantEvaluations.tsx
// - addParticipantEvaluation() pour table participant_evaluations
// - PrÃªt pour Phase 4 (boutons "Top" participants)
// - SÃ©parÃ© de la table postits du coach
```

#### 2. Adaptation TranscriptionHeader avec mode participant

```typescript
// âœ… MODIFIER : TranscriptionHeader.tsx
interface TranscriptionHeaderProps {
  mode?: "coach" | "participant"; // âœ… NOUVEAU PROP
  // ... autres props existantes
}

// Affichage conditionnel :
// âœ… ViewModeToggle : TOUJOURS affichÃ© (toggle local participants)
// âœ… ColorationToggle : TOUJOURS affichÃ©
// âœ… AddPostitButton : TOUJOURS affichÃ© (finalitÃ© participants)
// âŒ ShareEvaluationButton : MASQUÃ‰ en mode participant
// âŒ RefreshButton : MASQUÃ‰ en mode participant
// ğŸ”§ DisplayActions : ADAPTÃ‰ selon mode
```

#### 3. CrÃ©er les wrappers synchronisÃ©s

```typescript
// âœ… Ã€ CRÃ‰ER
app/whiteboard/components/SharedEvaluation/
â”œâ”€â”€ SynchronizedTranscript.tsx        // Wrapper de Transcript.tsx
â”œâ”€â”€ SynchronizedTranscriptAlt.tsx     // Wrapper de TranscriptAlternative.tsx
â”œâ”€â”€ SynchronizedAudioPlayer.tsx       // Wrapper d'AudioPlayer
â”œâ”€â”€ SharedEvaluationHeader.tsx        // Header participants
â””â”€â”€ index.tsx                         // Exports
```

#### 2. Structure des wrappers

```typescript
// Principe : RÃ©utiliser les composants existants en mode "spectateur"
const SynchronizedTranscript = ({
  sessionId,
  currentWordIndex,
  viewMode,
  // ... autres props synchronisÃ©es
}) => {
  // RÃ©cupÃ©rer les donnÃ©es du call via sessionId
  const { transcription, audioSrc } = useCallData()

  // Recevoir les mises Ã  jour temps rÃ©el
  const { currentPosition, isPlaying } = useRealtimeEvaluation({ sessionId })

  // Rendre le composant Transcript existant en mode lecture seule
  return (
    <Transcript
      callId={callId}
      hideHeader={true}
      readOnlyMode={true}        // âœ… NOUVEAU PROP
      highlightTurnOne={highlightTurnOne}
      currentWordIndex={currentWordIndex}  // âœ… IMPOSÃ‰ PAR SYNC
      onWordClick={undefined}    // âœ… DÃ‰SACTIVÃ‰
    />
  )
}
```

### Phase 3B : Extension des Composants Evaluation (0.5 jour)

#### Ajouter le mode "spectateur" aux composants existants

```typescript
// âœ… MODIFIER Transcript.tsx
interface TranscriptProps {
  // ... props existantes
  readOnlyMode?: boolean; // âœ… NOUVEAU
  forcedCurrentWordIndex?: number; // âœ… NOUVEAU
  disableInteraction?: boolean; // âœ… NOUVEAU
}

const Transcript = ({
  readOnlyMode = false,
  forcedCurrentWordIndex,
  disableInteraction = false,
  // ... autres props
}) => {
  // Si mode lecture seule, utiliser l'index forcÃ©
  const effectiveCurrentWordIndex =
    readOnlyMode && forcedCurrentWordIndex !== undefined
      ? forcedCurrentWordIndex
      : currentWordIndex;

  const handleWordClick = disableInteraction
    ? () => {}
    : (word, index) => {
        /* logique existante */
      };

  // ... reste du composant identique
};
```

#### MÃªme principe pour `TranscriptAlternative.tsx` et `AudioPlayer.tsx`

### Phase 3C : Extension WebSocket + Base de DonnÃ©es (0.5 jour)

#### Extension table shared_evaluation_sessions

```sql
-- âœ… AJOUTER colonnes pour synchronisation highlighting
ALTER TABLE whiteboard.shared_evaluation_sessions
ADD COLUMN view_mode VARCHAR(20) DEFAULT 'word',
ADD COLUMN current_word_index INTEGER DEFAULT 0,
ADD COLUMN current_paragraph_index INTEGER DEFAULT 0,
ADD COLUMN highlight_turn_one BOOLEAN DEFAULT false,
ADD COLUMN highlight_speakers BOOLEAN DEFAULT true;

-- âœ… Index pour performance
CREATE INDEX idx_shared_sessions_realtime
ON whiteboard.shared_evaluation_sessions(id, updated_at);
```

#### Extension useRealtimeEvaluation.tsx

```typescript
// âœ… Ã‰TENDRE interface WebSocket
interface RealtimeEvaluationData {
  // ... colonnes existantes
  view_mode: 'word' | 'paragraph'           // âœ… NOUVEAU
  current_word_index: number               // âœ… NOUVEAU
  current_paragraph_index: number          // âœ… NOUVEAU
  highlight_turn_one: boolean              // âœ… NOUVEAU
  highlight_speakers: boolean              // âœ… NOUVEAU
}

// âœ… Nouvelles fonctions broadcast
const broadcastHighlighting = (wordIndex: number, paragraphIndex: number)
const broadcastViewMode = (mode: 'word' | 'paragraph')
const broadcastColoration = (turnOne: boolean, speakers: boolean)
```

### Phase 3D : IntÃ©gration dans SharedEvaluationViewer (0.5 jour)

```typescript
// âœ… REMPLACER le placeholder existant
const SharedEvaluationViewer = ({ session }) => {
  const {
    viewMode,
    currentWordIndex,
    highlightTurnOne,
    highlightSpeakers
  } = useRealtimeEvaluation({ sessionId: session.id })

  return (
    <Box>
      <SharedEvaluationHeader
        sessionName={session.session_name}
        coachName={session.coach?.full_name}
        viewMode={viewMode}
      />

      {viewMode === 'word' ? (
        <SynchronizedTranscript
          sessionId={session.id}
          callId={session.call_id}
          currentWordIndex={currentWordIndex}
          highlightTurnOne={highlightTurnOne}
        />
      ) : (
        <SynchronizedTranscriptAlt
          sessionId={session.id}
          callId={session.call_id}
          highlightSpeakers={highlightSpeakers}
        />
      )}

      <SynchronizedAudioPlayer
        sessionId={session.id}
        callId={session.call_id}
      />
    </Box>
  )
}
```

## ğŸ¯ Points ClÃ©s d'Architecture

### 1. RÃ©utilisation Maximum

- **Ne PAS dupliquer** Transcript.tsx et TranscriptAlternative.tsx
- **Ã‰tendre** avec props mode spectateur
- **Wrapper** dans des composants synchronisÃ©s

### 2. DonnÃ©es CentralisÃ©es

```typescript
// âœ… Participants utilisent les mÃªmes hooks que le coach
const { transcription, audioSrc, createAudioUrlWithToken } = useCallData();
const { seekTo, currentTime, duration } = useAudio();

// âœ… + synchronisation temps rÃ©el
const { currentWordIndex, viewMode, isPlaying } = useRealtimeEvaluation();
```

### 3. Interface Identique

Les participants voient **exactement** :

- âœ… MÃªme transcription (word-by-word OU paragraphs)
- âœ… MÃªme timeline audio avec marqueurs post-its
- âœ… MÃªme highlighting en temps rÃ©el
- âœ… MÃªme coloration (tours de parole / locuteurs)
- âŒ PAS les boutons d'interaction (Phase 4)

## ğŸ§ª Plan de Tests Phase 3

### Test 1 : Mode Participant TranscriptionHeader âœ…

1. Ouvrir Whiteboard â†’ Session active
2. VÃ©rifier header "Transcription PartagÃ©e"
3. Boutons visibles : ViewMode, Coloration, AddPostit
4. Boutons masquÃ©s : Share, Refresh

### Test 2 : AccÃ¨s DonnÃ©es via Service Role âœ…

1. Participant non-authentifiÃ© charge session
2. API rÃ©cupÃ¨re transcription via `useCallData()` + service role
3. Audio URL gÃ©nÃ©rÃ©e via `createAudioUrlWithToken()`
4. Transcription affichÃ©e identique au coach

### Test 3 : Toggle ViewMode Local âœ…

1. Coach en mode "word", participant toggle vers "paragraph"
2. Coach garde mode "word", participant voit "paragraph"
3. Aucune synchronisation WebSocket (choix local)

### Test 4 : Synchronisation Highlighting Temps RÃ©el

1. Coach navigue transcription (clic mot/segment)
2. Broadcast `current_word_index` + `current_paragraph_index` via WebSocket
3. Participants voient highlighting synchronisÃ© instantanÃ©
4. Auto-scroll suit le coach

### Test 5 : Synchronisation Coloration

1. Coach toggle `highlight_turn_one` OU `highlight_speakers`
2. Broadcast changement via WebSocket
3. Participants voient coloration changer instantanÃ©ment

### Test 6 : PrÃ©paration Phase 4 - AddPostit Participants

1. Participant clique AddPostit
2. Utilise `addParticipantEvaluation()` â†’ table `participant_evaluations`
3. Ne pollue PAS la table `postits` du coach
4. Sauvegarde session_id + participant data

## ğŸ“Š Estimation Temps ActualisÃ©e

| Phase     | TÃ¢ches                               | DurÃ©e       | ComplexitÃ©  | Status          |
| --------- | ------------------------------------ | ----------- | ----------- | --------------- |
| 3A.1      | Hook ParticipantEvaluations          | 0.5 jour    | Facile      | âœ… CrÃ©Ã©         |
| 3A.2      | TranscriptionHeader mode participant | 0.5 jour    | Facile      | ğŸ”„ En cours     |
| 3A.3      | Wrappers synchronisÃ©s                | 1 jour      | Moyenne     | â³ Ã€ faire      |
| 3B        | Extension mode spectateur composants | 0.5 jour    | Facile      | â³ Ã€ faire      |
| 3C        | WebSocket highlighting + BDD         | 0.5 jour    | Facile      | â³ Ã€ faire      |
| 3D        | IntÃ©gration finale                   | 0.5 jour    | Facile      | â³ Ã€ faire      |
| **TOTAL** | **Phase 3 complÃ¨te**                 | **3 jours** | **Moyenne** | **ğŸ”„ 10% fait** |

## âœ… Actions ImmÃ©diates NÃ©cessaires

### 1. Permissions Storage Supabase â³

```sql
-- âœ… Ã€ FAIRE : Permissions sur storage pour accÃ¨s audio participants
GRANT SELECT ON storage.objects TO service_role;
GRANT SELECT ON storage.buckets TO service_role;

-- Test validation aprÃ¨s ajout des permissions :
-- VÃ©rifier que createAudioUrlWithToken() fonctionne avec service role
```

### 2. DÃ©veloppement Phase 3A (En cours)

- âœ… **useParticipantEvaluations.tsx** : Hook crÃ©Ã© pour Phase 4
- ğŸ”„ **TranscriptionHeader.tsx** : Mode participant en cours
- â³ **Wrappers synchronisÃ©s** : Ã€ crÃ©er aprÃ¨s TranscriptionHeader
- â³ **Extension composants** : Mode spectateur Ã  ajouter

### 3. Validation Technique

```bash
# Test accÃ¨s donnÃ©es participants non-authentifiÃ©s
# 1. CrÃ©er session depuis Evaluation (coach)
# 2. Ouvrir Whiteboard sans auth (participant)
# 3. VÃ©rifier chargement transcription + audio
```

## ğŸ¯ CritÃ¨res de SuccÃ¨s

### Fonctionnels

- âœ… Participants voient exactement la mÃªme transcription que le coach
- âœ… Switch word/paragraph synchronisÃ© temps rÃ©el
- âœ… Highlighting mot/segment synchronisÃ©
- âœ… Coloration synchronisÃ©e
- âœ… Timeline audio synchronisÃ©e

### Techniques

- âœ… RÃ©utilisation composants existants (pas de duplication)
- âœ… Props mode spectateur propres
- âœ… WebSocket stable <100ms latence
- âœ… Architecture extensible pour Phase 4

## ğŸ”œ PrÃ©paration Phase 4

Les composants auront les hooks nÃ©cessaires pour :

- âœ… Boutons "Toper" (remplacer interactions par actions participants)
- âœ… Modal commentaires (utiliser infrastructure postit existante)
- âœ… Sauvegarde `participant_evaluations`

---

**ğŸ¯ PRÃŠT POUR DÃ‰VELOPPEMENT PHASE 3 !**

_SpÃ©cification crÃ©Ã©e le 10/06/2025 - Session d'analyse architecture_
